---
layout: cover
background: https://sli.dev/demo-cover.png
download: true
---

# èŠèŠ DDD è®¾è®¡ï¼ˆ1ï¼‰

æ—¥æœŸ 23-11-23

---
layout: center
background: https://sli.dev/demo-cover.png
---

# é€šç”¨çš„é©±åŠ¨è®¾è®¡æœ‰å“ªäº›ï¼Ÿ

---
layout: center
---

# é€šç”¨çš„é©±åŠ¨è®¾è®¡æœ‰å“ªäº›ï¼Ÿ

## TDD - æµ‹è¯•é©±åŠ¨å¼€å‘

## BDD - è¡Œä¸ºé©±åŠ¨å¼€å‘

## DDD - æœ€åæœŸé™é©±åŠ¨å¼€å‘

---

# DDD æ˜¯ä»€ä¹ˆï¼Ÿ

DDD æ˜¯é¢†åŸŸé©±åŠ¨å¼€å‘ï¼Œå®ƒæ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ï¼Œå®ƒå¯ä»¥æŒ‡å¯¼ä¸šåŠ¡å»ºæ¨¡å’Œå¾®æœåŠ¡è®¾è®¡ã€‚

<img src="/ddd.png" style="height: 380px" />

---
layout: center
---

# æœ¬æ–‡ä¸»æ—¨

## æç‚¼é€šç”¨è¯­è¨€

## å¤æ‚åº¦é—®é¢˜

## è´«è¡€æ¨¡å‹ä¸å¯Œè¡€æ¨¡å‹

---
layout: center
---

# ä¸ºä»€ä¹ˆè¦è®¾è®¡é€šç”¨è¯­è¨€

> æˆ‘çš„è¯­è¨€ä¹‹ç•Œé™ï¼Œå³æˆ‘çš„ä¸–ç•Œä¹‹ç•Œé™ â€”â€” è·¯å¾·ç»´å¸ŒÂ·ç»´ç‰¹æ ¹æ–¯å¦

---
layout: center
---
# é€šç”¨è¯­è¨€çš„èŒƒå›´

## èŒƒå›´ â€”â€”> é¢†åŸŸ

## ç”¨ä¸€å¥è¯ä½“ç°ä½ ç°åœ¨åšçš„äº‹ï¼Ÿå¯¹æ–¹æ˜¯è°ï¼Ÿæ˜¯å¦äº†è§£æˆ‘çš„é¢†åŸŸï¼Ÿèƒ½å¦è®©ä¸æ˜¯æˆ‘è¿™ä¸ªé¢†åŸŸçš„äººå¬æ‡‚æˆ‘åœ¨åšçš„äº‹ï¼Ÿ

---
layout: center
---

# é€šç”¨è¯­è¨€çš„è®¤è¯†

## è®©å¤©ä¸‹æ²¡æœ‰éš¾åšçš„ç”Ÿæ„

## è®¢å•ï¼Œç”µå•†ï¼ŒçŸ­ä¿¡ï¼Œç‰©æµ

## æŠ“æ‰‹ï¼Œèµ‹èƒ½ï¼Œæœºå™¨å­¦ä¹ ï¼Œç¥ç»ç½‘ç»œ

---

# é€šç”¨è¯­è¨€çš„è½åœ°

## å˜é‡åï¼ˆé¢†åŸŸä½“ç°ï¼‰

## æ–¹æ³•åï¼ˆæˆ‘è¦åšä»€ä¹ˆï¼‰

<img src="/common-lan.png" style="height: 380px" />

---
layout: center
---

# å¤æ‚åº¦çš„ç±»å‹

## æœ¬è´¨å¤æ‚åº¦

æœ¬è´¨å¤æ‚åº¦å’Œå¾…æ±‚è§£é—®é¢˜çš„æœ¬è´¨æœ‰å…³ï¼Œæ˜¯æ— æ³•é¿å…çš„ã€‚å¦‚æŸäº›ä¼ä¸šæœåŠ¡ï¼Œæ•°æ®åº“ç®¡ç†è½¯ä»¶ï¼Œç¼–ç¨‹è¯­è¨€çš„è®¾è®¡ã€‚

## å¶ç„¶å¤æ‚åº¦

å¶ç„¶å¤æ‚åº¦ä¸€èˆ¬æ˜¯å› ä¸ºé€‰ç”¨æ±‚è§£é—®é¢˜çš„æ–¹æ³•æ—¶æ‰€å¼•å…¥çš„ï¼Œå’Œé—®é¢˜æœ¬è´¨æ— å…³ï¼Œå’Œé€‰ç”¨æ±‚è§£çš„å·¥å…·æˆ–æ–¹æ³•æœ‰å…³ã€‚ï¼ˆâš ï¸ï¼šéšç€è½¯ä»¶çš„ä¸æ–­è¿­ä»£ï¼Œè¦ä¸æ–­é™ä½å¶ç„¶å¤æ‚åº¦ï¼‰

---
layout: center
---

# è´«è¡€æ¨¡å‹å’Œå¯Œè¡€æ¨¡å‹

## é¢å‘å¯¹è±¡å’Œå‡½æ•°å¼åŒºåˆ«ï¼Ÿ

## ä¸ºä»€ä¹ˆé¢å‘å¯¹è±¡æ›´æœ‰åˆ©äºâ€œå¤æ‚â€ç³»ç»Ÿè®¾è®¡ï¼Ÿ

---
layout: center
---

# é¢å‘å¯¹è±¡å’Œå‡½æ•°å¼å…³æ³¨ç‚¹ï¼Ÿ

```ts
// å…³æ³¨æ•°æ®ï¼Œæ•°æ®çš„æµåŠ¨ä»¥åŠå˜åŒ–
let userInfo;

getUserInfo = () => {
    return userInfo
}

setUserInfo = (xxx) => {
    ...
}
```

```ts
class User {
  name: string;

  // å–å
  setName() {}

  // è¡Œä¸ºï¼ˆæ˜¯ä¸æ˜¯è¿™ä¸ªç±»è¯¥å¤„ç†ï¼‰
}
```

---

# è´«å¯Œè¡€æ¨¡å‹çš„ä»£ç 

```java
public IncreaseResponse increase(IncreaseRequest request) {

    final IncreaseResponseBuilder responseBuilder = new IncreaseResponseBuilder(request, IncreaseResponse.OK);

    //æ ¡éªŒå…¥å‚
    if (request.getAmount() <= 0) {
        return responseBuilder.error(IncreaseResponse.AMOUNT_LESS_THAN_ZERO).build();
    }

    Account account = accountDao.findByUserId(request.getUserId());

    //é˜²é‡æ ¡éªŒ
    boolean exists = accountRecordDao.exists(account.getId(),
            AccountRecord.TYPE_INCREASE,
            request.getSourceType(),
            request.getSourceId());

    if (exists) {
        return responseBuilder.error(IncreaseResponse.VERSION_CONFLICT).build();
    }

    transactionTemplate.execute(new TransactionCallbackWithoutResult() {
        @Override
        protected void doInTransactionWithoutResult(TransactionStatus status) {
            try {
                //æ›´æ–°ä½™é¢
                int result = accountDao.updateBalance(account.getId(),
                        account.getBalance() + request.getAmount(),
                        account.getVersion());

                //ä¹è§‚é”å†²çª
                if (result == 0) {
                    responseBuilder.error(IncreaseResponse.VERSION_CONFLICT);
                    status.setRollbackOnly();
                    return;
                }

                AccountRecord record = new AccountRecord();
                record.setAccountId(account.getId());
                record.setType(AccountRecord.TYPE_INCREASE);
                record.setSourceId(request.getSourceId());
                record.setSourceType(request.getSourceType());
                record.setAmount(request.getAmount());
                record.setCreated(LocalDateTime.now());

                //æ’å…¥å­è®°å½•
                int r = accountRecordDao.insert(record);
                System.out.println(r);
            } catch (Exception e) {
                responseBuilder.error(IncreaseResponse.UNKNOWN).errorMsg(e.getMessage());
                status.setRollbackOnly();
            }
        }
    });

    return responseBuilder.build();
}

```

# è´«è¡€æ¨¡å‹çš„ä»£ç 

```java
public IncreaseResponse increase(IncreaseRequest request) {

    final IncreaseResponseBuilder responseBuilder = new IncreaseResponseBuilder(request, IncreaseResponse.OK);

    //æ ¡éªŒå…¥å‚
    if (request.getAmount() <= 0) {
        return responseBuilder.error(IncreaseResponse.AMOUNT_LESS_THAN_ZERO).build();
    }

    Account account = accountDao.findByUserId(request.getUserId());

    //é˜²é‡æ ¡éªŒ
    boolean exists = accountRecordDao.exists(account.getId(),
            AccountRecord.TYPE_INCREASE,
            request.getSourceType(),
            request.getSourceId());

    if (exists) {
        return responseBuilder.error(IncreaseResponse.VERSION_CONFLICT).build();
    }

    transactionTemplate.execute(new TransactionCallbackWithoutResult() {
        @Override
        protected void doInTransactionWithoutResult(TransactionStatus status) {
            try {
                //æ›´æ–°ä½™é¢
                int result = accountDao.updateBalance(account.getId(),
                        account.getBalance() + request.getAmount(),
                        account.getVersion());

                //ä¹è§‚é”å†²çª
                if (result == 0) {
                    responseBuilder.error(IncreaseResponse.VERSION_CONFLICT);
                    status.setRollbackOnly();
                    return;
                }

                AccountRecord record = new AccountRecord();
                record.setAccountId(account.getId());
                record.setType(AccountRecord.TYPE_INCREASE);
                record.setSourceId(request.getSourceId());
                record.setSourceType(request.getSourceType());
                record.setAmount(request.getAmount());
                record.setCreated(LocalDateTime.now());

                //æ’å…¥å­è®°å½•
                int r = accountRecordDao.insert(record);
                System.out.println(r);
            } catch (Exception e) {
                responseBuilder.error(IncreaseResponse.UNKNOWN).errorMsg(e.getMessage());
                status.setRollbackOnly();
            }
        }
    });

    return responseBuilder.build();
}

```

---

# å¯Œè¡€æ¨¡å‹çš„ä»£ç 

```java
public RechargeResponse recharge(RechargeRequest request) {
    final RechargeResponse.Builder respBuilder = new RechargeResponse.Builder(request);

    //æ ¡éªŒå…¥å‚
    if (request.getAmount() <= 0) {
        return respBuilder.error(RechargeResponse.AMOUNT_LESS_THAN_ZERO).build();
    }

    transactionTemplate.execute(new TransactionCallbackWithoutResult() {
        @Override
        protected void doInTransactionWithoutResult(TransactionStatus status) {
            try {
                Account account = accountRepository.findByOwner(new Owner(request.getUserId()));
                Source source = new Source(request.getSourceId(), request.getSourceType());
                account.recharge(new Amount(request.getAmount()), source);
                accountRepository.save(account);
            } catch (RechargeDuplicateException e) {
                respBuilder.error(RechargeResponse.DUPLICATE_RECHARGE).errorMsg(e.getMessage());
                status.setRollbackOnly();
            }
            catch (OptimisticLockException e) {
                respBuilder.error(RechargeResponse.VERSION_CONFLICT).errorMsg(e.getMessage());
                status.setRollbackOnly();
            } catch (Exception e) {
                respBuilder.error(RechargeResponse.UNKNOWN).errorMsg(e.getMessage());
                status.setRollbackOnly();
            }
        }
    });

    return respBuilder.build();
}
```

---
layout: center
---

# å¯Œè¡€æ¨¡å‹åŒºåˆ«

## ä¸»è¦çš„é€»è¾‘éƒ½åœ¨serviceé‡Œï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯é—®é¢˜çš„ä»£ç æ··åœ¨ä¸€èµ·ï¼Œè¿™ç§serviceè¢«ç§°ä¸ºäº‹åŠ¡è„šæœ¬

## Serviceä½œä¸ºä¸€ä¸ªç”¨ä¾‹çš„å…¥å£ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼ŒæŠŠä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™é¢†åŸŸå¯¹è±¡ï¼Œå®ƒè‡ªå·±è´Ÿè´£æŠŠé¢†åŸŸå¯¹è±¡çš„è¡Œä¸ºä¸²è”èµ·æ¥ï¼Œå¹¶ä¸€äº›å¤„ç†æŠ€æœ¯ç›¸å…³çš„é—®é¢˜ï¼Œä»è€Œå®Œæˆä¸€ä¸ªå®Œæ•´çš„ç”¨ä¾‹

## åˆ†å¼€å¯¹å¾…æœ¬è´¨å¤æ‚åº¦å’Œå¶ç„¶å¤æ‚åº¦ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¢«å°è£…åœ¨é¢†åŸŸå¯¹è±¡é‡Œï¼Œå†…èšï¼Œå®¹æ˜“ä¿æŒä¸€è‡´æ€§ï¼Œä¸”å®¹æ˜“ç»´æŠ¤å’Œæ‰©å±•ã€‚æ­¤å¤–ï¼Œå®¹æ˜“æµ‹è¯•ï¼Œä¸”ä»£ç å’Œæµ‹è¯•éƒ½å¯ä»¥ä½œä¸ºæ–‡æ¡£ã€‚

---
layout: center
---

# å¯Œè¡€æ¨¡å‹é—®é¢˜

## å¯Œé¢†åŸŸå¯¹è±¡éœ€è¦ï¼š
- è¶³å¤Ÿå¤§çš„å†…å­˜
- å¹¶å‘è®¿é—®ä¸å¤š

## è¿™åœ¨å•æœºè½¯ä»¶é‡Œå¾ˆå¤šåœºæ™¯æ˜¯å¯è¡Œçš„ï¼Œä½†åœ¨ä¼ä¸šåº”ç”¨è½¯ä»¶é‡Œï¼Œå°¤å…¶æ˜¯äº’è”ç½‘è½¯ä»¶é‡Œï¼Œæ˜¯ä¸å¤ªå¯èƒ½çš„ã€‚

---
layout: center
---

# æ„Ÿè°¢ğŸ™
